name: PreProd Freeze Window Check

on:
  pull_request:
    branches:
      - pre-prod # Ensure this matches your target branch name
  workflow_dispatch:

jobs:
  freeze-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“… Determine current time window (12-1 PM or 5-6 PM IST)
        id: window
        run: |
          echo "Checking time against two merge windows: 12-1 PM IST and 5-6 PM IST..."
          
          # Get the current hour (H) and minute (M) in UTC
          H=$(date -u +%H)
          M=$(date -u +%M)
          
          # Convert current time to total minutes past midnight UTC
          CURRENT_MINUTES=$((10#$H * 60 + 10#$M))
          
          # Define Window 1 (12:00 PM - 1:00 PM IST) in UTC minutes
          W1_START=390  # 6:30 UTC
          W1_END=450    # 7:30 UTC

          # Define Window 2 (5:00 PM - 6:00 PM IST) in UTC minutes
          W2_START=690  # 11:30 UTC
          W2_END=750    # 12:30 UTC

          # Check if current time is within Window 1 OR Window 2
          IS_W1=$(( CURRENT_MINUTES >= W1_START && CURRENT_MINUTES < W1_END ))
          IS_W2=$(( CURRENT_MINUTES >= W2_START && CURRENT_MINUTES < W2_END ))
          
          if (( IS_W1 || IS_W2 )); then
            echo "Current Time ($H:$M UTC) is WITHIN an active merge window."
            echo "::set-output name=within_window::true"
          else
            echo "Current Time ($H:$M UTC) is OUTSIDE both merge windows."
            echo "::set-output name=within_window::false"
          fi
          
      - name: âœ… Auto-pass during merge window
        if: ${{ steps.window.outputs.within_window == 'true' }}
        run: |
          echo "Bypass"

      - name: âŒ Fail outside merge window (Enforce Freeze)
        if: ${{ steps.window.outputs.within_window == 'false' }}
        run: |
          echo "========================================================================="
          echo "âš ï¸ MERGE FREEZE ACTIVE: Merges are only permitted during 12-1 PM IST OR 5-6 PM IST."
          echo "Please wait for the next merge window to open."
          echo "========================================================================="
          exit 1
