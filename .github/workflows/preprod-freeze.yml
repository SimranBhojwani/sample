name: PreProd Freeze Window Check

on:
  # Triggers when a pull request is opened, synchronized (new commit), or ready to merge
  pull_request:
    branches:
      - pre-prod # Ensure this matches your target branch name
  # Allows manual triggering of the workflow
  workflow_dispatch:

jobs:
  freeze-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“… Determine current time window (5-6 PM IST / 11:30-12:30 UTC)
        id: window
        run: |
          echo "Checking time window..."
          
          # Get the current hour (H) and minute (M) in UTC, which is the runner's default
          H=$(date -u +%H)
          M=$(date -u +%M)
          
          # Convert current time to total minutes past midnight UTC
          CURRENT_MINUTES=$((10#$H * 60 + 10#$M))
          
          # Define the start and end of the 5:00 PM - 6:00 PM IST window in UTC minutes
          # 5:00 PM IST (11:30 UTC) = 11*60 + 30 = 690 minutes
          START_MINUTES=690
          # 6:00 PM IST (12:30 UTC) = 12*60 + 30 = 750 minutes
          END_MINUTES=750

          # Check if current time is within the window [START, END)
          if (( CURRENT_MINUTES >= START_MINUTES && CURRENT_MINUTES < END_MINUTES )); then
            echo "Current Time ($H:$M UTC) is WITHIN the 5-6 PM IST merge window."
            echo "::set-output name=within_window::true"
          else
            echo "Current Time ($H:$M UTC) is OUTSIDE the 5-6 PM IST merge window."
            echo "::set-output name=within_window::false"
          fi
          
      - name: âœ… Auto-pass during merge window
        # This step runs *only* if the time check passed
        if: ${{ steps.window.outputs.within_window == 'true' }}
        run: |
          echo "Merge window is OPEN. Check passes automatically."
          # This step will complete successfully, allowing the PR to be merged 
          # (assuming other required checks pass).

      - name: âŒ Fail outside merge window (Enforce Freeze)
        # This step runs *only* if the time check failed
        if: ${{ steps.window.outputs.within_window == 'false' }}
        run: |
          echo "========================================================================="
          echo "âš ï¸ MERGE FREEZE ACTIVE: Merges are only permitted between 5 PM and 6 PM IST."
          echo "Please wait for the next merge window to open."
          echo "========================================================================="
          # The 'exit 1' command is what forces the GitHub Actions job to fail, 
          # blocking the merge.
          exit 1
